---
- name: Download repo key
  register: terraform_key_download
  ansible.builtin.get_url:
    url: https://apt.releases.hashicorp.com/gpg
    dest: "{{ terraform_keyring }}.asc"
    mode: u=rw,g=r,o=r
    force: true
  tags:
    - terraform

- name: Check repo key
  register: terraform_key_status
  ansible.builtin.stat:
    path: "{{ terraform_keyring }}"
  tags:
    - terraform

- name: Dearmor repo key
  when:
    - terraform_key_download.changed or not terraform_key_status.stat.exists
  register: terraform_key_convert
  changed_when: terraform_key_convert.rc == 0
  ansible.builtin.command:
    cmd: "gpg --dearmor -o {{ terraform_keyring }} {{ terraform_keyring }}.asc"
  tags:
    - terraform

- name: Add apt repository
  ansible.builtin.apt_repository:
    repo: "deb [arch={{ terraform_arch }} signed-by={{ terraform_keyring }}] https://apt.releases.hashicorp.com {{ ansible_distribution_release }} main"
    filename: hashicorp
    update_cache: true
    state: present
  tags:
    - terraform

- name: Install required packages
  loop:
    - terraform
    - unzip
    - python3-pip
  ansible.builtin.package:
    name: "{{ item }}"
    state: present
  tags:
    - terraform

- name: Download tflint release
  when:
    - terraform_tflint_enabled
  ansible.builtin.unarchive:
    src: "{{ terraform_tflint_download }}"
    dest: "{{ terraform_install_path }}"
    include:
      - tflint
    remote_src: true
    owner: root
    group: root
    mode: u=rwx,g=rx,o=rx
  tags:
    - terraform

- name: Download tfsec release
  when:
    - terraform_tfsec_enabled
  ansible.builtin.unarchive:
    src: "{{ terraform_tfsec_download }}"
    dest: "{{ terraform_install_path }}"
    include:
      - tfsec
      - tfsec-checkgen
    remote_src: true
    owner: root
    group: root
    mode: u=rwx,g=rx,o=rx
  tags:
    - terraform

- name: Install checkov pip
  when:
    - terraform_checkov_enabled
  ansible.builtin.pip:
    name: checkov
    state: "{{ terraform_checkov_version is defined | ternary('present', 'latest') }}"
    version: "{{ terraform_checkov_version | default(omit) }}"
  tags:
    - terraform

...
